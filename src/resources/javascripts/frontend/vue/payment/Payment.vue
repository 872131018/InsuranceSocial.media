<template>
    <div class="w3-container w3-card-2 form">
        <div class="w3-panel">
            <h3>Plan Information</h3>
            <h5>Please confirm your plan or enter a promotion code.</h5>
        </div>
        <div class="w3-panel">
            <Cart
                v-bind:plan="plan"
                v-bind:reduction="reduction">
            </Cart>
        </div>
        <div class="w3-panel">
            <Discount
                v-bind:discount="discount"
                v-on:setDiscount="setDiscount($event)">
            </Discount>
        </div>
        <div class="w3-panel">
            <h3>Payment Method</h3>
            <h5>Please enter a form of payment to complete registration.</h5>
        </div>
        <div class="w3-panel">
            <Card v-on:setCard="(card) => { properties.card = card }"></Card>
        </div>
        <div class="w3-panel">
            <Expiration
                v-on:setMonth="(month) => { properties.month = month.value }"
                v-on:setYear="(year) => { properties.year = year }">
            </Expiration>
        </div>
        <div class="w3-panel">
            <CCV v-on:setCode="(code) => { properties.code = code }"></CCV>
        </div>
        <div class="w3-panel">
            <Name v-on:setName="(name) => { properties.name = name }"></Name>
        </div>
        <div class="w3-panel">
            <button class="w3-button w3-text-white primary"
                v-on:click="sendPaymentDataToAnet()">Complete
            </button>
        </div>
    </div>
</template>

<script>
    import Discount from './inputs/Discount';
    import Cart from './Cart';
    import Card from './inputs/Card';
    import Expiration from './inputs/Expiration';
    import CCV from './inputs/CCV';
    import Name from './inputs/Name';

    export default {
        data() {
            return {
                plan: {},
                reduction: '0.00',
                discount: '',
                properties: {
                    card: '',
                    month: '',
                    year: '',
                    code: '',
                    name: '',
                    apiLoginID: '',
                    clientKey: ''
                }
            }
        },
        mounted() {
            axios.get(window.location).then(response => {
                this.properties.apiLoginID = response.data.apiLoginID;
                this.properties.clientKey = response.data.clientKey;
            });

            this.plan = store.getState().UserStore.plan;
            if(store.getState().UserStore.discount) {
                setDiscount(store.getState().UserStore.discount);
            }
        },
        methods: {
            setDiscount(discount) {
                this.discount = discount;
                axios.put(`${ window.location }/${ this.discount }`,).then(response => {
                    this.reduction = response.data;
                });
            },
            sendPaymentDataToAnet() {
                const secureData = {
                    cardData: {
                        cardNumber: this.properties.card,
                        month: this.properties.month,
                        year: this.properties.year,
                        cardcode: this.properties.code
                    },
                    authData: {
                        apiLoginID: this.properties.apiLoginID,
                        clientKey: this.properties.clientKey
                    }
                };

                Accept.dispatchData(secureData, (response) => {
                    console.log(response)
                });

            },
        },
        components: {
            Discount,
            Cart,
            Card,
            Expiration,
            CCV,
            Name
        }
    }
</script>
