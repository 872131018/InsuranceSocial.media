<template>
    <div class="w3-container w3-card-2 form">
        <h3>Create a New Account</h3>
        <Name v-bind:label="'Full Name'"
            v-on:setName="setName($event)">
        </Name>
        <Email v-bind:label="'Email'"
            v-on:setEmail="setEmail($event)">
        </Email>
        <Email v-bind:label="'Confirm Email'"
            v-on:setEmail="confirmEmail($event)">
        </Email>
        <Password v-bind:label="'Password'"
            v-on:setPassword="setPassword($event)">
        </Password>
        <Password v-bind:label="'Confirm Password'"
            v-on:setPassword="confirmPassword($event)">
        </Password>
        <Discount v-bind:label="'Discount Code'"
            v-bind:code="properties.discount"
            v-on:setDiscount="setDiscount($event)">
        </Discount>
        <Terms v-on:setTerms="setTerms($event)"></Terms>
        <Errors v-bind:errors="errors"></Errors>
        <button class="w3-button w3-text-white primary"
            v-on:click="submit()">Register
        </button>
    </div>
</template>

<script>
    import Name from './Name';
    import Email from './Email';
    import Password from './Password';
    import Discount from './Discount';
    import Terms from './Terms';
    import Errors from './Errors';

    export default {
        data() {
            return {
                properties: {
                    name: '',
                    email: '',
                    email_confirmation: '',
                    password: '',
                    password_confirmation: '',
                    discount: this.$route.params.code,
                    terms: false,
                },
                errors: []
            }
        },
        methods: {
            setName(name) {
                this.properties.name = name;
            },
            setEmail(email) {
                this.properties.email = email;
            },
            confirmEmail(email) {
                this.properties.email_confirmation = email;
            },
            setPassword(password) {
                this.properties.password = password;
            },
            confirmPassword(password) {
                this.properties.password_confirmation = password;
            },
            setDiscount(discount) {
                this.properties.discount = discount;
            },
            setTerms(terms) {
                this.properties.terms = terms;
            },
            submit() {
                this.errors = [];
                if(this.properties.name == '') {
                    this.errors.push('You must enter your full name.');
                }
                if(this.properties.email == '' || this.properties.email_confirmation == '') {
                    this.errors.push('You must enter and confirm an email.');
                }
                if(this.properties.email != this.properties.email_confirmation) {
                    this.errors.push('Emails do not match.');
                }
                if(this.properties.password == '' || this.properties.password_confirmation == '') {
                    this.errors.push('You must enter and confirm a password');
                }
                if(this.properties.password != this.properties.password_confirmation) {
                    this.errors.push('Passwords do not match.');
                }
                if(!this.properties.terms) {
                    this.errors.push('You must accept the Terms of Service.');
                }
                if(this.errors.length == 0) {
                    axios.post(window.base_url + '/register', this.properties).then(response => {
                        let user = {
                            id: response.data.id,
                            name: response.data.name,
                            email: response.data.email,
                            api_token: response.data.api_token
                        };
                        store.dispatch({ type: 'SET_USER', data: user });
                        this.$router.push('/add-features');
                    });
                }
            }
        },
        components: {
            Name,
            Email,
            Password,
            Discount,
            Terms,
            Errors
        }
    }
</script>
